<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto Monitor Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
:root {
  --bg: #0d1117;
  --card: #161b22;
  --border: #30363d;
  --text: #e6edf3;
  --text2: #8b949e;
  --green: #3fb950;
  --red: #f85149;
  --blue: #58a6ff;
  --yellow: #d29922;
  --purple: #bc8cff;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}
h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; color: var(--text); }
h2 { font-size: 1.1rem; font-weight: 500; margin-bottom: 12px; color: var(--text2); }
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.header .meta { color: var(--text2); font-size: 0.85rem; }

/* Cards */
.stats-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}
.stat-card .label { font-size: 0.8rem; color: var(--text2); margin-bottom: 4px; }
.stat-card .value { font-size: 1.6rem; font-weight: 600; }
.stat-card .sub { font-size: 0.8rem; color: var(--text2); margin-top: 4px; }
.positive { color: var(--green); }
.negative { color: var(--red); }

/* Charts */
.chart-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 24px;
}
.chart-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}
.chart-card canvas { max-height: 250px; }

/* Tables */
.table-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 24px;
  overflow-x: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}
th {
  text-align: left;
  padding: 8px 10px;
  border-bottom: 1px solid var(--border);
  color: var(--text2);
  font-weight: 500;
  white-space: nowrap;
}
td {
  padding: 6px 10px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
tr:last-child td { border-bottom: none; }
tr:hover { background: rgba(88,166,255,0.05); }
.tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 500;
}
.tag-long { background: rgba(63,185,80,0.15); color: var(--green); }
.tag-short { background: rgba(248,81,73,0.15); color: var(--red); }

/* Tabs */
.tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 16px;
}
.tab {
  padding: 6px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  color: var(--text2);
  background: transparent;
  border: 1px solid transparent;
  transition: all 0.2s;
}
.tab:hover { color: var(--text); background: var(--card); }
.tab.active { color: var(--text); background: var(--card); border-color: var(--border); }

/* Breakdown grid */
.breakdown-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}
.breakdown-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}
.bar-row {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  font-size: 0.8rem;
}
.bar-label { width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bar-track { flex: 1; height: 6px; background: var(--border); border-radius: 3px; margin: 0 8px; }
.bar-fill { height: 100%; border-radius: 3px; }
.bar-value { width: 70px; text-align: right; font-weight: 500; }

/* Open positions */
.pos-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 8px;
}
.pos-item {
  background: rgba(88,166,255,0.05);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px;
  font-size: 0.8rem;
}
.pos-item .sym { font-weight: 600; font-size: 0.9rem; }

/* Responsive */
@media (max-width: 768px) {
  .chart-row { grid-template-columns: 1fr; }
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  body { padding: 12px; }
}

/* Loading */
.loading {
  text-align: center;
  padding: 60px;
  color: var(--text2);
}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ“Š Crypto Monitor</h1>
  <div class="meta">
    <span id="last-update"></span>
    <span style="margin-left:12px" id="auto-refresh">Auto-refresh: 30s</span>
  </div>
</div>

<div id="app"><div class="loading">Loading...</div></div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

let statsData = null;
let signalsData = null;
let charts = {};

async function fetchData() {
  try {
    const [statsRes, sigRes] = await Promise.all([
      fetch('/api/stats'),
      fetch('/api/signals?limit=100')
    ]);
    statsData = await statsRes.json();
    signalsData = await sigRes.json();
    render();
    $('#last-update').textContent = `Updated: ${new Date().toLocaleTimeString('zh-TW')}`;
  } catch(e) {
    console.error(e);
  }
}

function render() {
  if (!statsData) return;
  const d = statsData;

  const pnlClass = d.total_pnl >= 0 ? 'positive' : 'negative';
  const pnlSign = d.total_pnl >= 0 ? '+' : '';

  let html = `
    <div class="stats-row">
      <div class="stat-card">
        <div class="label">è³‡é‡‘</div>
        <div class="value ${pnlClass}">$${d.capital.toLocaleString()}</div>
        <div class="sub">${pnlSign}$${d.total_pnl.toLocaleString()} (${pnlSign}${((d.capital-10000)/100).toFixed(1)}%)</div>
      </div>
      <div class="stat-card">
        <div class="label">ç¸½äº¤æ˜“</div>
        <div class="value">${d.total_trades}</div>
        <div class="sub">é–‹æ”¾å€‰ä½: ${d.open_positions.length}</div>
      </div>
      <div class="stat-card">
        <div class="label">å‹ç‡</div>
        <div class="value">${d.win_rate}%</div>
        <div class="sub">LONG ${d.dir_stats.LONG?.wr||0}% / SHORT ${d.dir_stats.SHORT?.wr||0}%</div>
      </div>
      <div class="stat-card">
        <div class="label">LONG PnL</div>
        <div class="value ${d.dir_stats.LONG?.pnl>=0?'positive':'negative'}">$${d.dir_stats.LONG?.pnl?.toLocaleString()||0}</div>
        <div class="sub">${d.dir_stats.LONG?.count||0} ç­†, ${d.dir_stats.LONG?.wins||0} å‹</div>
      </div>
      <div class="stat-card">
        <div class="label">SHORT PnL</div>
        <div class="value ${d.dir_stats.SHORT?.pnl>=0?'positive':'negative'}">$${d.dir_stats.SHORT?.pnl?.toLocaleString()||0}</div>
        <div class="sub">${d.dir_stats.SHORT?.count||0} ç­†, ${d.dir_stats.SHORT?.wins||0} å‹</div>
      </div>
    </div>

    ${d.open_positions.length ? `
    <div class="table-card">
      <h2>ğŸ”“ é–‹æ”¾å€‰ä½</h2>
      <div class="pos-grid">
        ${d.open_positions.map(p => `
          <div class="pos-item">
            <div class="sym">${p.symbol} <span class="tag ${p.direction==='LONG'?'tag-long':'tag-short'}">${p.direction}</span></div>
            <div>å…¥å ´: $${p.entry}</div>
            <div>${p.grade} ${p.phase||''}</div>
          </div>
        `).join('')}
      </div>
    </div>` : ''}

    <div class="chart-row">
      <div class="chart-card">
        <h2>ğŸ’° è³‡é‡‘æ›²ç·š</h2>
        <canvas id="capitalChart"></canvas>
      </div>
      <div class="chart-card">
        <h2>ğŸ“ˆ æ»¾å‹•å‹ç‡ (20ç­†)</h2>
        <canvas id="wrChart"></canvas>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-card">
        <h2>ğŸ“… æ¯æ—¥æç›Š</h2>
        <canvas id="dailyChart"></canvas>
      </div>
      <div class="chart-card">
        <h2>ğŸ·ï¸ å‡ºå ´æ–¹å¼åˆ†ä½ˆ</h2>
        <canvas id="exitChart"></canvas>
      </div>
    </div>

    <div class="breakdown-grid">
      <div class="breakdown-card">
        <h2>â­ è©•ç´šç¸¾æ•ˆ</h2>
        ${renderBars(d.grade_stats)}
      </div>
      <div class="breakdown-card">
        <h2>ğŸ“ è¡Œæƒ…éšæ®µç¸¾æ•ˆ</h2>
        ${renderBars(d.phase_stats)}
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="showTab('trades')">æœ€è¿‘äº¤æ˜“</div>
      <div class="tab" onclick="showTab('signals')">ä¿¡è™Ÿç´€éŒ„</div>
    </div>

    <div id="tab-trades" class="table-card">
      <table>
        <tr>
          <th>æ™‚é–“</th><th>å¹£ç¨®</th><th>æ–¹å‘</th><th>è©•ç´š</th>
          <th>RSI</th><th>Vol</th><th>å‡ºå ´</th><th>PnL%</th><th>PnL$</th>
        </tr>
        ${d.recent_trades.slice().reverse().map(t => `
          <tr>
            <td>${t.closed_at.slice(5,16)}</td>
            <td><b>${t.symbol}</b></td>
            <td><span class="tag ${t.direction==='LONG'?'tag-long':'tag-short'}">${t.direction}</span></td>
            <td>${t.grade}</td>
            <td>${t.rsi}</td>
            <td>${t.vol_ratio}x</td>
            <td>${t.reason}</td>
            <td class="${t.pnl_pct>=0?'positive':'negative'}">${t.pnl_pct>0?'+':''}${t.pnl_pct}%</td>
            <td class="${t.pnl_usd>=0?'positive':'negative'}">$${t.pnl_usd>0?'+':''}${t.pnl_usd}</td>
          </tr>
        `).join('')}
      </table>
    </div>

    <div id="tab-signals" class="table-card" style="display:none">
      <table>
        <tr>
          <th>æ™‚é–“</th><th>å¹£ç¨®</th><th>æ–¹å‘</th><th>è©•ç´š</th>
          <th>OI%</th><th>1H%</th><th>RSI</th><th>CVD</th>
        </tr>
        ${(signalsData||[]).slice().reverse().slice(0,60).map(s => `
          <tr>
            <td>${s.ts.slice(5,16)}</td>
            <td><b>${s.symbol}</b></td>
            <td><span class="tag ${s.signal==='LONG'?'tag-long':'tag-short'}">${s.signal}</span></td>
            <td>${s.grade}</td>
            <td>${s.oi_pct}%</td>
            <td class="${s.price_1h>=0?'positive':'negative'}">${s.price_1h>0?'+':''}${s.price_1h}%</td>
            <td>${s.rsi}</td>
            <td>${s.cvd}</td>
          </tr>
        `).join('')}
      </table>
    </div>
  `;

  $('#app').innerHTML = html;
  drawCharts(d);
}

function renderBars(stats) {
  const entries = Object.entries(stats).sort((a,b) => b[1].pnl - a[1].pnl);
  const maxAbs = Math.max(...entries.map(([,v]) => Math.abs(v.pnl)), 1);
  return entries.map(([label, v]) => {
    const pct = Math.abs(v.pnl) / maxAbs * 100;
    const color = v.pnl >= 0 ? 'var(--green)' : 'var(--red)';
    const cls = v.pnl >= 0 ? 'positive' : 'negative';
    return `<div class="bar-row">
      <div class="bar-label" title="${label}">${label||'(ç©º)'}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color}"></div></div>
      <div class="bar-value ${cls}">$${v.pnl} (${v.wr}%)</div>
    </div>`;
  }).join('');
}

function showTab(name) {
  $$('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-trades').style.display = name === 'trades' ? '' : 'none';
  document.getElementById('tab-signals').style.display = name === 'signals' ? '' : 'none';
  event.target.classList.add('active');
}

function drawCharts(d) {
  Object.values(charts).forEach(c => c.destroy());
  charts = {};

  const chartDefaults = {
    responsive: true,
    maintainAspectRatio: true,
    plugins: { legend: { display: false } },
    scales: {
      x: { ticks: { color: '#8b949e', maxTicksLimit: 8 }, grid: { color: '#21262d' } },
      y: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } }
    }
  };

  // Capital curve
  charts.capital = new Chart($('#capitalChart'), {
    type: 'line',
    data: {
      labels: d.capital_curve.map((_, i) => i),
      datasets: [{
        data: d.capital_curve,
        borderColor: '#58a6ff',
        borderWidth: 1.5,
        fill: { target: 'origin', above: 'rgba(88,166,255,0.05)', below: 'rgba(248,81,73,0.05)' },
        pointRadius: 0,
        tension: 0.3
      }]
    },
    options: {
      ...chartDefaults,
      scales: {
        ...chartDefaults.scales,
        x: { ...chartDefaults.scales.x, display: false }
      }
    }
  });

  // WR curve
  charts.wr = new Chart($('#wrChart'), {
    type: 'line',
    data: {
      labels: d.wr_curve.map((_, i) => i + 20),
      datasets: [{
        data: d.wr_curve,
        borderColor: '#d29922',
        borderWidth: 1.5,
        pointRadius: 0,
        tension: 0.3
      }, {
        data: d.wr_curve.map(() => 50),
        borderColor: '#30363d',
        borderWidth: 1,
        borderDash: [4,4],
        pointRadius: 0
      }]
    },
    options: {
      ...chartDefaults,
      scales: {
        ...chartDefaults.scales,
        x: { ...chartDefaults.scales.x, display: false },
        y: { ...chartDefaults.scales.y, min: 0, max: 100 }
      }
    }
  });

  // Daily PnL
  const days = Object.keys(d.daily_pnl);
  const dayVals = Object.values(d.daily_pnl);
  charts.daily = new Chart($('#dailyChart'), {
    type: 'bar',
    data: {
      labels: days.map(d => d.slice(5)),
      datasets: [{
        data: dayVals,
        backgroundColor: dayVals.map(v => v >= 0 ? 'rgba(63,185,80,0.6)' : 'rgba(248,81,73,0.6)'),
        borderRadius: 3
      }]
    },
    options: chartDefaults
  });

  // Exit reasons pie
  const exitEntries = Object.entries(d.exit_stats).sort((a,b) => b[1].count - a[1].count).slice(0, 8);
  const pieColors = ['#58a6ff','#3fb950','#f85149','#d29922','#bc8cff','#f0883e','#8b949e','#56d364'];
  charts.exit = new Chart($('#exitChart'), {
    type: 'doughnut',
    data: {
      labels: exitEntries.map(([k]) => k),
      datasets: [{
        data: exitEntries.map(([,v]) => v.count),
        backgroundColor: pieColors,
        borderColor: '#161b22',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'right', labels: { color: '#8b949e', boxWidth: 12, font: { size: 11 } } }
      }
    }
  });
}

// Init
fetchData();
setInterval(fetchData, 30000);
</script>
</body>
</html>
